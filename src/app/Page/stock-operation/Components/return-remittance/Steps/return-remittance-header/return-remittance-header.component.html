<div fxLayout="column">
  <div fxLayout="row" fxLayoutGap="15px" fxLayoutAlign="start center">
    <mat-form-field fxFlex="20%" class="input-size input-text-size" appearance="outline" color="primary">
      <mat-label>تاریخ تنظیم</mat-label>
      <input matInput [matDatepicker]="picker" placeholder="تاریخ تنظیم " #datePicker readonly
      (dateChange)="onChange($event)" formControlName="datePicker">
      <mat-datepicker-toggle matSuffix [for]="picker"></mat-datepicker-toggle>
      <mat-datepicker #picker>
        <mat-datepicker-actions>
          <button mat-button matDatepickerCancel>انصراف</button>
          <button mat-raised-button color="primary" matDatepickerApply>تایید</button>
        </mat-datepicker-actions>
      </mat-datepicker>
      <!-- <mat-error *ngIf="errorHandling('datePicker', 'required')">
              وارد کردن تاریخ اجباری است
            </mat-error> -->
    </mat-form-field>
    <mat-form-field fxFlex="30%" class=" w-100 input-text-size" appearance="outline" style="font-size: 12px;">
      <mat-select placeholder="شخص/مشتری ..." #personSelect formControlName="personSelect">
        <mat-select-trigger>
          {{ personSelect.value?.name }}
        </mat-select-trigger>
        <mat-option>
          <ngx-mat-select-search [formControl]="personFilterCtrl" placeholderLabel="جستجو..."
            noEntriesFoundLabel="موردی یافت نشد"></ngx-mat-select-search>
        </mat-option>
        <mat-option class="mt-2" *ngFor="let person of filterPerson | async ;let i=index;" [value]="person">
          <!-- <span>{{i}}</span> -->
          <span> {{person.name}}</span>
          <!-- <span>{{person.mobile}}</span> -->
          <!-- <div fxLayout="row" fxLayoutAlign="space-between">
                              <span> {{person.name}}</span>
                              <span>{{person.mobile}}</span>
                          </div> -->
          <!-- {{person.name}}---{{person.mobile}} -->
        </mat-option>
      </mat-select>
      <!-- <mat-error *ngIf="errorHandling('personSelect', 'required')">
              انتخاب شخص اجباری است
            </mat-error> -->
    </mat-form-field>


    <button class="me-3 mb-3 btn-height" mat-flat-button mat-Stroked-button color="primary"
      [disabled]="!personSelect.value" (click)="getCustomerFactorDetail(personSelect.value.id)">
      <span fxLayout fxLayoutAlign="center center">
        <span color="primary">جستجوی حواله منتخب</span>
        <mat-spinner *ngIf="isLoading$ | async" class="mx-2" color="accent" diameter="20">
        </mat-spinner>
      </span>
    </button>
  </div>
  <div *ngIf="isLoading$ | async; else dataTable" fxLayout="column" fxLayoutAlign="center center">
    <div class="loading-shade" *ngIf="isLoading$ | async">
      <div fxLayout="column" fxLayoutAlign="center center">
        <mat-progress-spinner [strokeWidth]="3" [diameter]="30" [mode]="'indeterminate'" *ngIf="isLoading$ | async"></mat-progress-spinner>
        <h3 class="mt-3">در حال دریافت اطلاعت از سرور ...</h3>
      </div>
    </div>
  </div>
  <ng-template #dataTable>
    <div fxLayout="row" fxLayoutGap="20px">
      <!-- <mat-form-field appearance="outline">
        <mat-label>Choose an option</mat-label>
        <mat-select  #selectSearchType>
          <mat-option value="date">براساس تاریخ</mat-option>
          <mat-option value="id" >براساس شماره سند</mat-option>
        </mat-select>
      </mat-form-field> -->
      <mat-form-field appearance="standard" >
        <mat-label>فیلتر</mat-label>
        <input matInput (keyup)="applyFilter($event)" placeholder="مثال : 100" #input [disabled]="!(dataSource.data.length>0)">
        <!-- [disabled]="selectSearchType.value" -->
      </mat-form-field>
    </div>


    <div class="table-container">
      <table mat-table [dataSource]="dataSource" multiTemplateDataRows class=" w-100 text-right">
        <!-- collapse Column -->
        <ng-container matColumnDef="collapse">
          <th mat-header-cell *matHeaderCellDef class="mat-column-small-width-collapse" >
            <!-- <button mat-icon-button color="primary">
              <mat-icon>add_box_outline</mat-icon>
            </button> -->
          </th>
          <td mat-cell *matCellDef="let element" class="mat-column-small-width" matTooltip="نمایش جزییات">
            <button mat-icon-button color="primary"
              (click)="expandedElement = expandedElement === element ? null : element">
              <mat-icon>{{expandedElement === element ? 'expand_less' : 'expand_more'}}</mat-icon>
            </button>
          </td>
        </ng-container>

        <!-- Index Column -->
        <ng-container matColumnDef="index">
          <th class="text-right" mat-header-cell *matHeaderCellDef class="mat-column-small-width"> ردیف</th>
          <td class="text-right mat-column-small-width" mat-cell *matCellDef="let element; let i = dataIndex;">
            {{i+1}}
          </td>
        </ng-container>
  
  
        <!-- stockOperationId Column -->
        <ng-container matColumnDef="stockOperationId">
          <th mat-header-cell *matHeaderCellDef style="width: 120px;"> شماره سند </th>
          <td mat-cell *matCellDef="let element">{{element.stockOperationId}}</td>
  
        </ng-container>
  
        <!-- registerDate Column -->
        <ng-container matColumnDef="registerDate">
          <th mat-header-cell class="text-right" *matHeaderCellDef style="width: 120px;"> تاریخ تنظیم </th>
          <td class="text-right" mat-cell *matCellDef="let element" > {{getShamsi(element.registerDate)}} </td>
        </ng-container>
  
        <!-- stockName Column -->
        <ng-container matColumnDef="stockName">
          <th mat-header-cell class="text-right" *matHeaderCellDef style="width: 120px;"> انبار </th>
          <td class="text-right" mat-cell *matCellDef="let element"> {{getStockNameById(element.stockId)}} </td>
        </ng-container>
        <!-- Description Column -->
        <ng-container matColumnDef="description">
          <th mat-header-cell class="text-right" *matHeaderCellDef style="width: 220px;"> توضیحات </th>
          <td class="text-right" mat-cell *matCellDef="let element"> {{ element.description}}
          </td>
        </ng-container>
        <!-- Description Column -->
        <ng-container matColumnDef="select">
          <th mat-header-cell class="text-right" *matHeaderCellDef >حواله مبنا</th>
          <td class="text-right" mat-cell *matCellDef="let element"> 
            <button mat-flat-button mat-Stroked-button (click)="getDetailFromRemittance(element,personSelect.value)">انتخاب
              <i class="icon-check icon-20px selet-remittance-btn" ></i>

            </button>
          </td>
        </ng-container>
        <ng-container matColumnDef="expandedDetail">
          <td mat-cell *matCellDef="let element" [attr.colspan]="displayedColumns.length">
            <div class="example-element-detail" 
                 [@detailExpand]="element == expandedElement ? 'expanded' : 'collapsed'">
                 <div class="p-2" fxLayout="row" fxFill >
                   <app-remittance-detail-table class="w-100" [data]="element.customerFactorGoods"></app-remittance-detail-table>
                 </div>
            </div>
          </td>
        </ng-container>
  
        <tr mat-header-row *matHeaderRowDef="displayedColumns ; sticky: true"></tr>
        <tr mat-row *matRowDef="let element; columns: displayedColumns;" class="example-element-row"
          [class.example-expanded-row]="expandedElement === element">
        </tr>
        <tr class="mat-row" *matNoDataRow>
          <td class="mat-cell" [colSpan]="displayedColumns.length+1">
            <div fxLayout="row" fxFill fxLayoutAlign="center center">
              <div  class="warning-box mt-2">
                <span>اطلاعاتی جهت نمایش وجود ندارد</span>
              </div>
  
            </div>
          </td>
        </tr>
        <tr mat-row *matRowDef="let row; columns: ['expandedDetail']" class="example-detail-row"></tr>
  
      </table>
    </div>
  </ng-template>
</div>
